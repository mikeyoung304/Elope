name: Database Schema Drift Detection

# Purpose: Detect schema drift between production database and git
# Reference: ADR-003 (Database Architecture Audit)
# Adapted from rebuild-6.0 drift-check.yml

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read      # Checkout code
  issues: write       # Create/update drift detection issues

jobs:
  detect-drift:
    name: Check for Schema Drift
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Save current schema
        run: |
          cp server/prisma/schema.prisma /tmp/schema-before.prisma

      - name: Introspect production database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "::group::Introspecting Production Database"
          cd server && npx prisma db pull
          echo "::endgroup::"

      - name: Check for drift
        id: drift-check
        run: |
          echo "::group::Comparing Schemas"

          if diff /tmp/schema-before.prisma server/prisma/schema.prisma > /tmp/schema-diff.txt; then
            echo "âœ… No schema drift detected"
            echo "Production database matches git schema"
            echo "drift=false" >> "$GITHUB_OUTPUT"
          else
            echo "âŒ Schema drift detected!"
            echo ""
            echo "Differences found between production and git:"
            cat /tmp/schema-diff.txt
            echo ""
            echo "drift=true" >> "$GITHUB_OUTPUT"

            # Count number of changes
            CHANGES=$(wc -l < /tmp/schema-diff.txt)
            echo "change_count=$CHANGES" >> "$GITHUB_OUTPUT"
          fi

          echo "::endgroup::"

      - name: Create or update drift issue
        if: steps.drift-check.outputs.drift == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('/tmp/schema-diff.txt', 'utf8');
            const changeCount = '${{ steps.drift-check.outputs.change_count }}';

            const body = '## ðŸš¨ Database Schema Drift Detected\n\n' +
              '**Status:** Production database schema does not match git repository\n\n' +
              `**Changes detected:** ${changeCount} lines different\n\n` +
              `**Last checked:** ${new Date().toISOString()}\n\n` +
              '---\n\n' +
              '### Schema Differences\n\n' +
              '```diff\n' +
              `${diff}\n` +
              '```\n\n' +
              '---\n\n' +
              '### What Caused This?\n\n' +
              'Schema drift usually happens when:\n' +
              '- Manual changes made via Supabase Dashboard\n' +
              '- Migration deployed but Prisma schema not updated in git\n' +
              '- Direct SQL changes via psql or other tools\n\n' +
              '### Remediation Steps\n\n' +
              '**Option 1: Accept drift and update git (if changes are intentional)**\n' +
              '```bash\n' +
              '# Update Prisma schema to match production\n' +
              'cd server && npx prisma db pull\n\n' +
              '# Regenerate Prisma client\n' +
              'npx prisma generate\n\n' +
              '# Commit the updated schema\n' +
              'git add server/prisma/schema.prisma\n' +
              'git commit -m "chore(schema): sync Prisma with production drift"\n' +
              'git push\n' +
              '```\n\n' +
              '**Option 2: Revert production to match git (if changes are unintentional)**\n' +
              '```bash\n' +
              '# Create rollback migration\n' +
              'cd server && npx prisma migrate dev --name rollback_drift\n\n' +
              '# Review and deploy\n' +
              'npx prisma migrate deploy\n' +
              '```\n\n' +
              '---\n\n' +
              '### Prevention\n\n' +
              'To prevent future drift:\n' +
              '1. **Never** make schema changes via Supabase Dashboard\n' +
              '2. **Always** use `npx prisma migrate dev` to create migrations\n' +
              '3. **Always** run `npx prisma generate` after schema changes\n' +
              '4. Enable required status checks on pull requests\n\n' +
              '---\n\n' +
              '**Auto-detected by drift check workflow**\n' +
              '*Runs daily at 9 AM UTC*';

            // Find existing drift issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'schema-drift'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              const issue = issues.data[0];
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: body
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ðŸ”„ Drift still detected on ${new Date().toISOString()}\n\nChanges: ${changeCount} lines different`
              });

              console.log(`Updated existing drift issue #${issue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Database Schema Drift Detected',
                body: body,
                labels: ['database', 'schema-drift', 'needs-investigation']
              });

              console.log(`Created new drift issue #${newIssue.data.number}`);
            }

      - name: Close drift issues if no drift
        if: steps.drift-check.outputs.drift == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Find open drift issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'schema-drift'
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… Schema drift resolved!\n\nProduction database now matches git schema.\n\nVerified: ${new Date().toISOString()}`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              console.log(`Closed drift issue #${issue.number}`);
            }

      - name: Create summary
        if: always()
        run: |
          {
            echo "## ðŸ” Drift Detection Summary"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ steps.drift-check.outputs.drift }}" == "true" ]; then
            {
              echo "### âŒ Drift Detected"
              echo ""
              echo "**Changes:** ${{ steps.drift-check.outputs.change_count }} lines different"
              echo ""
              echo "A GitHub issue has been created with details and remediation steps."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### âœ… No Drift"
              echo ""
              echo "Production database schema matches git repository."
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "---"
            echo "*Checked at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          } >> "$GITHUB_STEP_SUMMARY"
