================================================================================
                    TODO TESTS INVENTORY - FINAL REPORT
                         MAIS Platform Codebase
================================================================================

SUMMARY
-------
Total Todo Tests Found: 12
All located in: /Users/mikeyoung/CODING/MAIS/server/test/http/webhooks.http.spec.ts
Test Framework: Vitest (with supertest HTTP integration)
Feature Area: Stripe webhook handling and payment processing

================================================================================
                          TESTS BY CATEGORY
================================================================================

CATEGORY 1: SIGNATURE VERIFICATION (3 tests)
Line 36-44   Test 1  "should reject webhook without signature header"
             Status: Unimplemented
             Complexity: SIMPLE
             Expected: HTTP 400, error message about signature

Line 46-55   Test 2  "should reject webhook with invalid signature"
             Status: Unimplemented
             Complexity: SIMPLE
             Expected: HTTP 401, "Invalid signature" message

Line 57-72   Test 3  "should accept webhook with valid signature"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: HTTP 200, received: true in response
             Note: Requires crypto HMAC-SHA256 implementation

CATEGORY 2: IDEMPOTENCY & DUPLICATE HANDLING (2 tests)
Line 76-100  Test 4  "should return 200 for duplicate webhook"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: HTTP 200, duplicate: true, one DB record only

Line 102-129 Test 5  "should not process duplicate webhook"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: HTTP 200, no duplicate booking created

CATEGORY 3: ERROR HANDLING (3 tests)
Line 133-141 Test 6  "should return 400 for invalid JSON"
             Status: Unimplemented
             Complexity: SIMPLE
             Expected: HTTP 400, no DB records created

Line 143-156 Test 7  "should return 422 for missing required fields"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: HTTP 422, webhook marked FAILED in DB

Line 158-178 Test 8  "should return 500 for internal server errors"
             Status: Unimplemented
             Complexity: COMPLEX
             Expected: HTTP 500, webhook marked FAILED with error

CATEGORY 4: EVENT TYPE HANDLING (2 tests)
Line 182-216 Test 9  "should handle checkout.session.completed events"
             Status: Unimplemented
             Complexity: COMPLEX
             Expected: HTTP 200, booking created, webhook PROCESSED

Line 218-234 Test 10 "should ignore unsupported event types"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: HTTP 200, ignored: true, no booking created

CATEGORY 5: WEBHOOK RECORDING & AUDIT TRAIL (2 tests)
Line 238-260 Test 11 "should record all webhook events in database"
             Status: Unimplemented
             Complexity: MEDIUM
             Expected: WebhookEvent record with eventId, type, status

Line 262-290 Test 12 "should mark failed webhooks in database"
             Status: Unimplemented
             Complexity: COMPLEX
             Expected: WebhookEvent marked FAILED with lastError

================================================================================
                        COMPLEXITY BREAKDOWN
================================================================================

SIMPLE (2 tests) - < 40 lines of implementation code
  - Test 1: Missing signature header
  - Test 6: Invalid JSON error

MEDIUM (6 tests) - 40-60 lines of implementation code
  - Test 2: Invalid signature
  - Test 3: Valid signature with crypto
  - Test 4: Duplicate webhook returns 200
  - Test 5: Duplicate not processed
  - Test 7: Missing fields validation
  - Test 10: Unsupported event types
  - Test 11: Webhook event recording

COMPLEX (4 tests) - 60+ lines of implementation code
  - Test 8: Database failure handling (requires DB mocking)
  - Test 9: Checkout completion (full flow integration)
  - Test 12: Failed event tracking (error scenarios)

================================================================================
                       RECOMMENDED IMPLEMENTATION ORDER
================================================================================

PHASE 1: QUICK WINS (Start immediately)
Priority: HIGH
Estimated Time: 2-3 hours
Tests: 1, 6, 2
Reason: Simple tests with minimal dependencies
Output: 3 green tests, basic signature validation coverage

PHASE 2: CORE FUNCTIONALITY (Follow Phase 1)
Priority: HIGH
Estimated Time: 4-5 hours
Tests: 3, 4, 5, 7, 10
Reason: Core webhook functionality, needed for Phase 3
Output: 8 green tests, 67% of test suite implemented
Dependencies: Complete Phase 1 first

PHASE 3: ADVANCED FEATURES (Final phase)
Priority: HIGH
Estimated Time: 5-6 hours
Tests: 11, 8, 9, 12
Reason: Complex integration testing, database scenarios
Output: 12 green tests, 100% of test suite implemented
Dependencies: Complete Phase 2 first

Total Estimated Time: 11-14 hours of implementation

================================================================================
                          KEY IMPLEMENTATION REQUIREMENTS
================================================================================

CRITICAL HELPER FUNCTION (Line 298-308)
File: webhooks.http.spec.ts
Function: generateTestSignature(payload: string): string
Current State: Returns placeholder 'test_signature_placeholder'
Required Implementation:
  1. Import crypto module
  2. Get current timestamp (Math.floor(Date.now() / 1000))
  3. Create HMAC-SHA256 using STRIPE_WEBHOOK_SECRET
  4. Format: `t={timestamp},v1={signature}`
  5. Return formatted signature string

REQUIRED ENVIRONMENT VARIABLES
  - STRIPE_WEBHOOK_SECRET: Webhook signing secret from Stripe
  - DATABASE_URL: Test database connection string
  - ADAPTERS_PRESET: Set to 'mock' for isolated testing (optional)

REQUIRED SETUP IN TEST FILE
  1. Express app instance configured with raw body parsing middleware
  2. Prisma client connection to test database
  3. Test tenant record in database with valid API keys
  4. beforeEach/afterEach hooks to manage Prisma lifecycle

TEST DATABASE STATE MANAGEMENT
  1. Clear WebhookEvent table before each test
  2. Clear Booking table for booking creation tests
  3. Ensure test tenant exists with proper configuration
  4. Clean up after tests (afterEach hook)

================================================================================
                            SOURCE CODE REFERENCES
================================================================================

WEBHOOK IMPLEMENTATION DETAILS

Main Route Handler:
  File: /Users/mikeyoung/CODING/MAIS/server/src/routes/webhooks.routes.ts
  
  Key Methods:
  - handleStripeWebhook(rawBody, signature) - Lines 113-273
    * Signature verification: Lines 117-122
    * Idempotency check: Lines 137-143
    * Event recording: Lines 145-151
    * Zod validation: Lines 158-181
    * Event processing: Lines 155-248
    * Error handling: Lines 252-272

Webhook Repository:
  File: /Users/mikeyoung/CODING/MAIS/server/src/adapters/prisma/webhook.repository.ts
  
  Key Methods:
  - isDuplicate(tenantId, eventId) - Lines 36-68
    * Checks for duplicate using composite key
    * Updates status to DUPLICATE on retry
  - recordWebhook(input) - Lines 92-129
    * Creates new WebhookEvent with PENDING status
    * Handles unique constraint violations
  - markProcessed(tenantId, eventId) - Lines 147-162
    * Updates status to PROCESSED with timestamp
  - markFailed(tenantId, eventId, errorMessage) - Lines 185-201
    * Updates status to FAILED, stores error message

Error Classes:
  - WebhookValidationError - For signature/schema validation failures
  - WebhookProcessingError - For processing failures

Zod Schemas (in routes file):
  - StripeSessionSchema (Lines 18-31) - Validates session structure
  - MetadataSchema (Lines 49-58) - Validates metadata fields

Database Models:
  - WebhookEvent table in Prisma schema
    * Composite unique constraint: (tenantId, eventId)
    * Statuses: PENDING, PROCESSED, DUPLICATE, FAILED
    * Fields: eventId, eventType, status, rawPayload, lastError, attempts, processedAt

================================================================================
                          COMMON TEST PATTERNS
================================================================================

PATTERN 1: BASIC HTTP REQUEST
  const response = await request(app)
    .post('/v1/webhooks/stripe')
    .set('stripe-signature', signature)
    .send(payload)
    .expect(200);
  expect(response.body.field).toBe(expectedValue);

PATTERN 2: VERIFY DATABASE STATE
  const record = await prisma.webhookEvent.findUnique({
    where: { tenantId_eventId: { tenantId, eventId } }
  });
  expect(record).not.toBeNull();
  expect(record?.status).toBe('PROCESSED');

PATTERN 3: DUPLICATE DETECTION
  // Send webhook first time
  await request(app).post('/v1/webhooks/stripe')...expect(200);
  
  // Send webhook second time (duplicate)
  const response = await request(app)
    .post('/v1/webhooks/stripe')...expect(200);
  expect(response.body.duplicate).toBe(true);
  
  // Verify only one DB record
  const count = await prisma.webhookEvent.count({
    where: { eventId }
  });
  expect(count).toBe(1);

PATTERN 4: PAYLOAD GENERATION
  const payload = JSON.stringify({
    id: 'evt_test',
    type: 'checkout.session.completed',
    data: { object: { id: 'cs_test', ... } }
  });
  const signature = generateTestSignature(payload);

================================================================================
                          DOCUMENTATION FILES CREATED
================================================================================

1. TODO_TESTS_CATALOG.md (18 KB)
   - Comprehensive inventory of all 12 tests
   - Detailed implementation hints for each test
   - Full line-by-line breakdown
   - Related code references
   - Expected behavior documentation

2. QUICK_REFERENCE_TODOS.md (4.7 KB)
   - At-a-glance table of all tests
   - Implementation roadmap with phases
   - Quick patterns and templates
   - Test data examples

3. TODO_TESTS_SUMMARY.txt (This file)
   - High-level overview
   - Complexity breakdown
   - Implementation priority
   - Key requirements checklist

================================================================================
                              NEXT STEPS
================================================================================

1. IMPLEMENT HELPER FUNCTION (1-2 hours)
   - Implement generateTestSignature() at line 298-308
   - Test with real Stripe webhook secret
   - Verify signature format matches Stripe expectations

2. SETUP TEST INFRASTRUCTURE (1-2 hours)
   - Ensure Express app is properly initialized in tests
   - Configure raw body parsing middleware
   - Verify Prisma test database connection
   - Create test tenant with valid configuration

3. IMPLEMENT PHASE 1 TESTS (2-3 hours)
   - Test 1: Missing signature header
   - Test 6: Invalid JSON error
   - Test 2: Invalid signature
   - Run tests frequently to validate setup

4. IMPLEMENT PHASE 2 TESTS (4-5 hours)
   - Implement signature validation with real crypto
   - Implement idempotency tests with DB assertions
   - Implement missing fields validation
   - Implement unsupported event type handling

5. IMPLEMENT PHASE 3 TESTS (5-6 hours)
   - Implement webhook event recording with full assertions
   - Implement database failure scenario
   - Implement full booking creation flow
   - Implement failed webhook tracking

6. FINAL VALIDATION (1-2 hours)
   - Run full test suite: npm test -- webhooks.http.spec.ts
   - Verify all 12 tests pass
   - Check coverage increase from 60% to 75%+
   - Commit changes to git

================================================================================
                            ESTIMATED IMPACT
================================================================================

Current State:
- 0/12 tests passing (0%)
- Test coverage: 60%
- Integration test gap for webhook endpoint

After Implementation:
- 12/12 tests passing (100%)
- Test coverage: 75%+ (estimated 15% increase)
- Comprehensive webhook endpoint coverage
- Full signature verification validation
- Idempotency and duplicate detection tested
- Error handling and edge cases covered
- Audit trail and logging verified

Impact Areas:
- Stripe payment integration (webhook handling)
- Booking creation from webhook events
- Error recovery and retry logic
- Security (signature verification)
- Data integrity (idempotency)

================================================================================
