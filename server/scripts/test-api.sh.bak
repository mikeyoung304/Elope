#!/bin/bash

# Test API Multi-Tenant Isolation
# Tests API authentication and data isolation with X-Tenant-Key headers

set -e  # Exit on error

echo "ðŸ§ª Testing Multi-Tenant API Authentication"
echo "=========================================="
echo ""

# API Base URL
BASE_URL="http://localhost:3001"

# Database URL
DB_URL="postgresql://postgres:%40Orangegoat11@db.gpyvdknhmevcfdbgtqir.supabase.co:5432/postgres"

# Get tenant API keys from database
echo "ðŸ“‹ Fetching tenant API keys..."
read -r TENANT_A_KEY TENANT_B_KEY <<< $(psql "$DB_URL" -t -c "SELECT string_agg(\"apiKeyPublic\", ' ') FROM (SELECT \"apiKeyPublic\" FROM \"Tenant\" WHERE slug IN ('tenant-a', 'tenant-b') ORDER BY slug) AS keys;")
echo "âœ“ Tenant A key: $TENANT_A_KEY"
echo "âœ“ Tenant B key: $TENANT_B_KEY"
echo ""

# Test 1: Valid Tenant A key
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 1: Valid API key (Tenant A)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Tenant-Key: $TENANT_A_KEY" "$BASE_URL/v1/packages")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
BODY=$(echo "$RESPONSE" | head -n -1)

if [ "$HTTP_CODE" = "200" ]; then
  PACKAGE_COUNT=$(echo "$BODY" | jq 'length')
  echo "âœ… PASS: HTTP $HTTP_CODE"
  echo "   Returned $PACKAGE_COUNT package(s) for Tenant A"
  echo "$BODY" | jq -r '.[] | "   - \(.name)"'
else
  echo "âŒ FAIL: HTTP $HTTP_CODE"
  echo "$BODY"
  exit 1
fi
echo ""

# Test 2: Valid Tenant B key
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 2: Valid API key (Tenant B)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Tenant-Key: $TENANT_B_KEY" "$BASE_URL/v1/packages")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
BODY=$(echo "$RESPONSE" | head -n -1)

if [ "$HTTP_CODE" = "200" ]; then
  PACKAGE_COUNT=$(echo "$BODY" | jq 'length')
  echo "âœ… PASS: HTTP $HTTP_CODE"
  echo "   Returned $PACKAGE_COUNT package(s) for Tenant B"
  echo "$BODY" | jq -r '.[] | "   - \(.name)"'
else
  echo "âŒ FAIL: HTTP $HTTP_CODE"
  echo "$BODY"
  exit 1
fi
echo ""

# Test 3: Missing API key
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 3: Missing X-Tenant-Key header"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
RESPONSE=$(curl -s -w "\n%{http_code}" "$BASE_URL/v1/packages")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
BODY=$(echo "$RESPONSE" | head -n -1)

if [ "$HTTP_CODE" = "401" ]; then
  ERROR_CODE=$(echo "$BODY" | jq -r '.code')
  echo "âœ… PASS: HTTP $HTTP_CODE"
  echo "   Error code: $ERROR_CODE"
  echo "   Message: $(echo "$BODY" | jq -r '.error')"
else
  echo "âŒ FAIL: Expected 401, got $HTTP_CODE"
  echo "$BODY"
  exit 1
fi
echo ""

# Test 4: Invalid API key
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 4: Invalid API key"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Tenant-Key: pk_live_invalid_12345678" "$BASE_URL/v1/packages")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
BODY=$(echo "$RESPONSE" | head -n -1)

if [ "$HTTP_CODE" = "401" ]; then
  ERROR_CODE=$(echo "$BODY" | jq -r '.code')
  echo "âœ… PASS: HTTP $HTTP_CODE"
  echo "   Error code: $ERROR_CODE"
  echo "   Message: $(echo "$BODY" | jq -r '.error')"
else
  echo "âŒ FAIL: Expected 401, got $HTTP_CODE"
  echo "$BODY"
  exit 1
fi
echo ""

# Test 5: Malformed API key
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 5: Malformed API key"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-Tenant-Key: not-a-valid-key" "$BASE_URL/v1/packages")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
BODY=$(echo "$RESPONSE" | head -n -1)

if [ "$HTTP_CODE" = "401" ]; then
  ERROR_CODE=$(echo "$BODY" | jq -r '.code')
  echo "âœ… PASS: HTTP $HTTP_CODE"
  echo "   Error code: $ERROR_CODE"
  echo "   Message: $(echo "$BODY" | jq -r '.error')"
else
  echo "âŒ FAIL: Expected 401, got $HTTP_CODE"
  echo "$BODY"
  exit 1
fi
echo ""

# Test 6: Data isolation verification
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Test 6: Tenant data isolation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Get packages for Tenant A
PACKAGES_A=$(curl -s -H "X-Tenant-Key: $TENANT_A_KEY" "$BASE_URL/v1/packages" | jq -r '.[] | .name')
PACKAGES_B=$(curl -s -H "X-Tenant-Key: $TENANT_B_KEY" "$BASE_URL/v1/packages" | jq -r '.[] | .name')

# Verify Test Package A is in Tenant A's results
if echo "$PACKAGES_A" | grep -q "Test Package A"; then
  echo "âœ… PASS: Tenant A sees 'Test Package A'"
else
  echo "âŒ FAIL: Tenant A missing 'Test Package A'"
  exit 1
fi

# Verify Test Package A is NOT in Tenant B's results
if ! echo "$PACKAGES_B" | grep -q "Test Package A"; then
  echo "âœ… PASS: Tenant B does NOT see 'Test Package A' (isolation working)"
else
  echo "âŒ FAIL: Tenant B can see 'Test Package A' (data leakage!)"
  exit 1
fi

# Verify Test Package B is in Tenant B's results
if echo "$PACKAGES_B" | grep -q "Test Package B"; then
  echo "âœ… PASS: Tenant B sees 'Test Package B'"
else
  echo "âŒ FAIL: Tenant B missing 'Test Package B'"
  exit 1
fi

# Verify Test Package B is NOT in Tenant A's results
if ! echo "$PACKAGES_A" | grep -q "Test Package B"; then
  echo "âœ… PASS: Tenant A does NOT see 'Test Package B' (isolation working)"
else
  echo "âŒ FAIL: Tenant A can see 'Test Package B' (data leakage!)"
  exit 1
fi
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL API AUTHENTICATION TESTS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Summary:"
echo "  - Tenant A and B can authenticate with valid keys"
echo "  - Missing/invalid keys are properly rejected (401)"
echo "  - Tenants only see their own data (isolation verified)"
echo ""
