<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAIS SDK Test Suite</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border-left: 4px solid #ccc;
    }
    .test-section.pass {
      border-left-color: #10B981;
    }
    .test-section.fail {
      border-left-color: #EF4444;
    }
    .test-section h3 {
      margin: 0 0 10px 0;
    }
    .result {
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .pass .result { background: #D1FAE5; color: #065F46; }
    .fail .result { background: #FEE2E2; color: #991B1B; }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
    }
    button:hover {
      background: #4338CA;
    }
    #mais-widget {
      min-height: 400px;
      border: 2px dashed #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>MAIS Widget SDK Test Suite</h1>

  <div class="test-section" id="test-script-load">
    <h3>1. Script Loading Test</h3>
    <div class="result" id="result-script-load">Testing...</div>
  </div>

  <div class="test-section" id="test-config">
    <h3>2. Configuration Test</h3>
    <div class="result" id="result-config">Testing...</div>
  </div>

  <div class="test-section" id="test-api-key">
    <h3>3. API Key Validation Test</h3>
    <div class="result" id="result-api-key">Testing...</div>
  </div>

  <div class="test-section" id="test-widget-instance">
    <h3>4. Widget Instance Test</h3>
    <div class="result" id="result-widget-instance">Testing...</div>
  </div>

  <div class="test-section" id="test-methods">
    <h3>5. Public API Methods Test</h3>
    <div class="result" id="result-methods">Testing...</div>
  </div>

  <div class="test-section" id="test-events">
    <h3>6. Event System Test</h3>
    <div class="result" id="result-events">Testing...</div>
    <button onclick="testEventEmission()">Test Event Emission</button>
  </div>

  <div class="test-section" id="test-iframe">
    <h3>7. Iframe Creation Test</h3>
    <div class="result" id="result-iframe">Testing...</div>
  </div>

  <div class="test-section" id="test-url">
    <h3>8. Widget URL Test</h3>
    <div class="result" id="result-url">Testing...</div>
    <pre id="widget-url"></pre>
  </div>

  <h2>Widget Container</h2>
  <div id="mais-widget"></div>

  <h2>Interactive Tests</h2>
  <div class="test-section">
    <button onclick="testOpenBooking()">Test openBooking()</button>
    <button onclick="testClose()">Test close()</button>
    <button onclick="testDestroy()">Test destroy()</button>
  </div>

  <!-- Load SDK -->
  <script
    src="./mais-sdk.js"
    data-tenant="bellaweddings"
    data-api-key="pk_live_bellaweddings_a3f8c9d2e1b4f7g8"
    data-container="mais-widget">
  </script>

  <!-- Test Suite -->
  <script>
    // Test results
    var testResults = {
      scriptLoad: false,
      config: false,
      apiKey: false,
      widgetInstance: false,
      methods: false,
      events: false,
      iframe: false,
      url: false
    };

    function updateTest(testId, passed, message) {
      var section = document.getElementById('test-' + testId);
      var result = document.getElementById('result-' + testId);

      section.className = 'test-section ' + (passed ? 'pass' : 'fail');
      result.textContent = (passed ? '✓ PASS: ' : '✗ FAIL: ') + message;

      testResults[testId] = passed;
    }

    // Run tests after a short delay
    setTimeout(function() {
      runTests();
    }, 500);

    function runTests() {
      // Test 1: Script loaded
      updateTest('script-load', true, 'SDK script loaded successfully');

      // Test 2: Configuration
      var hasConfig = window.MAISWidget && window.MAISWidget.config;
      updateTest('config', hasConfig, hasConfig
        ? 'Configuration object exists'
        : 'Configuration object not found');

      // Test 3: API Key validation
      var apiKeyValid = window.MAISWidget &&
        window.MAISWidget.config.apiKey === 'pk_live_bellaweddings_a3f8c9d2e1b4f7g8';
      updateTest('api-key', apiKeyValid, apiKeyValid
        ? 'API key correctly parsed: ' + (window.MAISWidget ? window.MAISWidget.config.apiKey : 'N/A')
        : 'API key validation failed');

      // Test 4: Widget instance
      var hasInstance = window.MAISWidget && typeof window.MAISWidget === 'object';
      updateTest('widget-instance', hasInstance, hasInstance
        ? 'MAISWidget instance available on window object'
        : 'MAISWidget instance not found on window');

      // Test 5: Public API methods
      var hasMethods = window.MAISWidget &&
        typeof window.MAISWidget.on === 'function' &&
        typeof window.MAISWidget.openBooking === 'function' &&
        typeof window.MAISWidget.close === 'function' &&
        typeof window.MAISWidget.destroy === 'function';
      updateTest('methods', hasMethods, hasMethods
        ? 'All public methods available: on(), openBooking(), close(), destroy()'
        : 'Missing public methods');

      // Test 6: Event system
      var eventTestPassed = false;
      if (window.MAISWidget && typeof window.MAISWidget.on === 'function') {
        try {
          window.MAISWidget.on('test-event', function() {});
          eventTestPassed = true;
        } catch (e) {
          console.error('Event system error:', e);
        }
      }
      updateTest('events', eventTestPassed, eventTestPassed
        ? 'Event system initialized and ready'
        : 'Event system failed to initialize');

      // Test 7: Iframe creation
      setTimeout(function() {
        var iframe = document.querySelector('#mais-widget iframe');
        var hasIframe = iframe !== null;
        updateTest('iframe', hasIframe, hasIframe
          ? 'Iframe created successfully in container'
          : 'Iframe not found in container');

        // Test 8: Widget URL
        if (iframe) {
          var url = iframe.src;
          var urlValid = url.indexOf('tenant=bellaweddings') > -1 &&
                        url.indexOf('apiKey=pk_live_') > -1 &&
                        url.indexOf('parentOrigin=') > -1;

          updateTest('url', urlValid, urlValid
            ? 'Widget URL formatted correctly with all parameters'
            : 'Widget URL missing required parameters');

          document.getElementById('widget-url').textContent = url;
        } else {
          updateTest('url', false, 'Cannot test URL - iframe not created');
        }

        // Show summary
        showSummary();
      }, 1000);
    }

    function showSummary() {
      var total = Object.keys(testResults).length;
      var passed = Object.values(testResults).filter(function(r) { return r; }).length;
      var failed = total - passed;

      console.log('=== TEST SUMMARY ===');
      console.log('Total Tests:', total);
      console.log('Passed:', passed);
      console.log('Failed:', failed);
      console.log('Success Rate:', Math.round((passed / total) * 100) + '%');
      console.log('===================');
    }

    // Interactive test functions
    function testOpenBooking() {
      if (window.MAISWidget) {
        window.MAISWidget.openBooking('luxury-package');
        console.log('✓ openBooking("luxury-package") called');
      }
    }

    function testClose() {
      if (window.MAISWidget) {
        window.MAISWidget.close();
        console.log('✓ close() called');
      }
    }

    function testDestroy() {
      if (confirm('This will destroy the widget. Reload page to restore.')) {
        if (window.MAISWidget) {
          window.MAISWidget.destroy();
          console.log('✓ destroy() called - widget removed');
        }
      }
    }

    function testEventEmission() {
      if (window.MAISWidget) {
        // Register a test handler
        window.MAISWidget.on('test-custom-event', function(data) {
          alert('Custom event fired with data: ' + JSON.stringify(data));
        });

        // Emit the event
        window.MAISWidget.emit('test-custom-event', { test: 'data' });
        console.log('✓ Event emission test completed');
      }
    }

    // Listen for real widget events
    if (window.MAISWidget) {
      window.MAISWidget.on('ready', function() {
        console.log('✓ Widget READY event received');
      });

      window.MAISWidget.on('bookingCreated', function(data) {
        console.log('✓ BOOKING_CREATED event received:', data);
      });

      window.MAISWidget.on('bookingCompleted', function(data) {
        console.log('✓ BOOKING_COMPLETED event received:', data);
      });

      window.MAISWidget.on('error', function(data) {
        console.log('✗ ERROR event received:', data);
      });
    }
  </script>
</body>
</html>
